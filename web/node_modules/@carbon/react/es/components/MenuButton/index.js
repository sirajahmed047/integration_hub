/**
 * Copyright IBM Corp. 2016, 2023
 *
 * This source code is licensed under the Apache-2.0 license found in the
 * LICENSE file in the root directory of this source tree.
 */

import { extends as _extends } from '../../_virtual/_rollupPluginBabelHelpers.js';
import React__default, { forwardRef, useRef, useState } from 'react';
import PropTypes from 'prop-types';
import cx from 'classnames';
import { ChevronDown } from '@carbon/icons-react';
import Button from '../Button/Button.js';
import '../Button/Button.Skeleton.js';
import { Menu } from '../Menu/Menu.js';
import '../Menu/MenuItem.js';
import { useAttachedMenu } from '../../internal/useAttachedMenu.js';
import { useId } from '../../internal/useId.js';
import { useMergedRefs } from '../../internal/useMergedRefs.js';
import { usePrefix } from '../../internal/usePrefix.js';

const spacing = 0; // top and bottom spacing between the button and the menu. in px
const validButtonKinds = ['primary', 'tertiary', 'ghost'];
const defaultButtonKind = 'primary';
const MenuButton = /*#__PURE__*/forwardRef(function MenuButton(_ref, forwardRef) {
  let {
    children,
    className,
    disabled,
    kind = defaultButtonKind,
    label,
    size = 'lg',
    menuAlignment = 'bottom',
    tabIndex = 0,
    ...rest
  } = _ref;
  const id = useId('MenuButton');
  const prefix = usePrefix();
  const triggerRef = useRef(null);
  const menuRef = useRef(null);
  const ref = useMergedRefs([forwardRef, triggerRef]);
  const [width, setWidth] = useState(0);
  const {
    open,
    x,
    y,
    handleClick: hookOnClick,
    handleMousedown,
    handleClose
  } = useAttachedMenu(triggerRef);
  function handleClick() {
    if (triggerRef.current) {
      const {
        width: w
      } = triggerRef.current.getBoundingClientRect();
      setWidth(w);
      hookOnClick();
    }
  }
  function handleOpen() {
    if (menuRef.current) {
      menuRef.current.style.inlineSize = `${width}px`;
      menuRef.current.style.minInlineSize = `${width}px`;
      if (menuAlignment !== 'bottom' && menuAlignment !== 'top') {
        menuRef.current.style.inlineSize = `fit-content`;
      }
    }
  }
  const containerClasses = cx(`${prefix}--menu-button__container`, className);
  const triggerClasses = cx(`${prefix}--menu-button__trigger`, {
    [`${prefix}--menu-button__trigger--open`]: open
  });
  const menuClasses = cx(`${prefix}--menu-button__${menuAlignment}`);
  return /*#__PURE__*/React__default.createElement("div", _extends({}, rest, {
    ref: ref,
    "aria-owns": open ? id : undefined,
    className: containerClasses
  }), /*#__PURE__*/React__default.createElement(Button, {
    className: triggerClasses,
    size: size,
    tabIndex: tabIndex,
    kind: kind,
    renderIcon: ChevronDown,
    disabled: disabled,
    "aria-haspopup": true,
    "aria-expanded": open,
    onClick: handleClick,
    onMouseDown: handleMousedown,
    "aria-controls": open ? id : undefined
  }, label), /*#__PURE__*/React__default.createElement(Menu, {
    containerRef: triggerRef,
    menuAlignment: menuAlignment,
    className: menuClasses,
    ref: menuRef,
    id: id,
    label: label,
    mode: "basic",
    size: size,
    open: open,
    onClose: handleClose,
    onOpen: handleOpen,
    x: x,
    y: [y[0] - spacing, y[1] + spacing]
  }, children));
});
MenuButton.propTypes = {
  /**
   * A collection of MenuItems to be rendered as actions for this MenuButton.
   */
  children: PropTypes.node.isRequired,
  /**
   * Additional CSS class names.
   */
  className: PropTypes.string,
  /**
   * Specify whether the MenuButton should be disabled, or not.
   */
  disabled: PropTypes.bool,
  /**
   * Specify the type of button to be used as the base for the trigger button.
   */
  // @ts-ignore-next-line -- avoid spurious (?) TS2322 error
  kind: PropTypes.oneOf(validButtonKinds),
  /**
   * Provide the label to be renderd on the trigger button.
   */
  label: PropTypes.string.isRequired,
  /**
   * Experimental property. Specify how the menu should align with the button element
   */
  // @ts-ignore-next-line -- avoid spurious (?) TS2322 error
  menuAlignment: PropTypes.oneOf(['top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end']),
  /**
   * Specify the size of the button and menu.
   */
  // @ts-ignore-next-line -- avoid spurious (?) TS2322 error
  size: PropTypes.oneOf(['sm', 'md', 'lg']),
  /**
   * Specify the tabIndex of the button.
   */
  // @ts-ignore-next-line -- avoid spurious (?) TS2322 error
  tabIndex: PropTypes.number
};

export { MenuButton };
